<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسيير الفواتير</title>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --white: #ffffff;
            
            /* ألوان الحالات */
            --orange: #e65100;
            --orange-light: #fff3e0;
            --orange-border: #ffb74d;

            --green: #2e7d32;
            --green-light: #e8f5e9;
            --green-border: #81c784;

            --red: #c62828;
            --red-light: #ffebee;
            --red-border: #ef5350;

            --blue: #1565c0;
            --blue-light: #e3f2fd;
            --blue-border: #64b5f6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
        }

        /* --- التاريخ --- */
        .date-control {
            margin-bottom: 25px;
            text-align: center;
        }
        .date-control input {
            padding: 8px 25px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-family: inherit;
            outline: none;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- شريط الفلترة والأزرار (Filters) --- */
        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .filter-card {
            background: var(--white);
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100px;
        }

        .filter-card:hover { transform: translateY(-3px); }

        .filter-card h3 {
            margin: 0 0 8px 0;
            font-size: 0.85rem;
            font-weight: bold;
            color: #666;
        }

        .filter-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            direction: ltr;
        }

        .filter-card .sub-info {
            font-size: 0.75rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* ألوان الفلاتر */
        /* الكل */
        .filter-card.blue { border-bottom: 4px solid var(--blue); }
        .filter-card.blue .value { color: var(--blue); }
        .filter-card.blue.active { background-color: var(--blue); border-color: var(--blue); }
        .filter-card.blue.active h3, .filter-card.blue.active .value, .filter-card.blue.active .sub-info { color: white; }

        /* برتقالي (للمراجعة) */
        .filter-card.orange { border-bottom: 4px solid var(--orange); }
        .filter-card.orange .value { color: var(--orange); }
        .filter-card.orange.active { background-color: var(--orange); border-color: var(--orange); }
        .filter-card.orange.active h3, .filter-card.orange.active .value, .filter-card.orange.active .sub-info { color: white; }

        /* أخضر (للاستخلاص) */
        .filter-card.green { border-bottom: 4px solid var(--green); }
        .filter-card.green .value { color: var(--green); }
        .filter-card.green.active { background-color: var(--green); border-color: var(--green); }
        .filter-card.green.active h3, .filter-card.green.active .value, .filter-card.green.active .sub-info { color: white; }

        /* أحمر (مستخلص) */
        .filter-card.red { border-bottom: 4px solid var(--red); }
        .filter-card.red .value { color: var(--red); }
        .filter-card.red.active { background-color: var(--red); border-color: var(--red); }
        .filter-card.red.active h3, .filter-card.red.active .value, .filter-card.red.active .sub-info { color: white; }


        /* --- نموذج الإدخال --- */
        .input-section {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"], input[type="number"] {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            flex: 1;
            font-size: 1rem;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #eee;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-wrapper input { transform: scale(1.3); }

        button#addBtn {
            padding: 12px 25px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button#addBtn:hover { background-color: #000; }

        /* --- القائمة --- */
        .records-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .record-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            border-right: 6px solid #ccc;
            transition: all 0.3s ease;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .record-info strong { display: block; font-size: 1.1rem; }
        .record-info span { font-size: 0.85rem; opacity: 0.7; }
        .record-info .date-tag { font-size: 0.75rem; color: #888; margin-right: 5px; background: #eee; padding: 2px 6px; border-radius: 4px; }

        /* وسم الوقت */
        .record-info .time-tag {
            font-size: 0.75rem;
            color: #666;
            margin-right: 6px;
            opacity: 0.9;
        }

        .record-amount { font-weight: bold; font-size: 1.3rem; margin-left: 15px; direction: ltr; }

        .actions { display: flex; gap: 8px; }
        
        button.action-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        /* تنسيق الحالات في القائمة */
        .status-pending { border-right-color: var(--orange); background: var(--orange-light); }
        .status-pending .record-amount { color: var(--orange); }

        .status-checked { border-right-color: var(--green); background: var(--green-light); }
        .status-checked .record-amount { color: var(--green); }

        .status-paid { border-right-color: var(--red); background: var(--red-light); opacity: 0.8; }
        .status-paid .record-amount { color: var(--red); text-decoration: line-through; }

        /* الأزرار */
        .check-btn { background: #fff; border: 1px solid #ccc; }
        .check-btn:hover { background: #eee; }
        .check-btn.is-checked { background: var(--green); color: white; border-color: var(--green); }

        .pay-btn { background: #333; color: white; }
        .pay-btn:hover { background: var(--red); }
        .pay-btn:disabled { background: #ccc; cursor: not-allowed; }

        .delete-btn { background: transparent; border: 1px solid #ccc; color: #777; }
        .delete-btn:hover { color: red; border-color: red; }

        @media (max-width: 600px) {
            .filters-container { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="date-control">
        <input type="date" id="currentDate">
    </div>

    <!-- 2. أزرار الفلترة والتفاصيل (Filters) -->
    <div class="filters-container">
        
        <!-- الكل (يعرض المبلغ الإجمالي لليوم) -->
        <div class="filter-card blue active" onclick="setFilter('all')" id="filter-all">
            <h3>المجموع (اليوم)</h3>
            <div class="value" id="val-all">0.00</div>
            <div class="sub-info" id="count-all">0 عملية</div>
        </div>

        <!-- البرتقالي (للمراجعة - كل الأيام) -->
        <div class="filter-card orange" onclick="setFilter('pending')" id="filter-pending">
            <h3>الباقي </h3>
            <div class="value" id="val-pending">0.00</div>
            <div class="sub-info" id="count-pending">0 عملية</div>
        </div>

        <!-- الأخضر (جاهز - كل الأيام) -->
        <div class="filter-card green" onclick="setFilter('ready')" id="filter-ready">
            <h3>خالص</h3>
            <div class="value" id="val-ready">0.00</div>
            <div class="sub-info" id="count-ready">0 عملية</div>
        </div>

        <!-- الأحمر (مستخلص - اليوم) -->
        <div class="filter-card red" onclick="setFilter('paid')" id="filter-paid">
            <h3>مستخلص (اليوم)</h3>
            <div class="value" id="val-paid">0.00</div>
            <div class="sub-info" id="count-paid">0 عملية</div>
        </div>

    </div>

    <!-- الإدخال -->
    <div class="input-section">
        <div class="form-row">
            <input type="text" id="serviceType" list="servicesList" placeholder="نوع الخدمة (كتابة عربية)" autocomplete="off">
            <datalist id="servicesList"></datalist>
            
            <input type="number" id="amount" placeholder="المبلغ" step="0.01">
            
            <label class="checkbox-wrapper">
                <input type="checkbox" id="initialCheck">
                <span>وضع علامة</span>
            </label>
            
            <button id="addBtn">إضافة</button>
        </div>
    </div>

    <!-- القائمة -->
    <div class="records-list" id="recordsList"></div>

</div>

<!-- أضف هنا مكتبات Firebase قبل سكربت التطبيق -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
    // --- 1. تحويل الحروف للعربية ---
    const arabicMapping = {
        'q': 'ض', 'w': 'ص', 'e': 'ث', 'r': 'ق', 't': 'ف', 'y': 'غ', 'u': 'ع', 'i': 'ه', 'o': 'خ', 'p': 'ح', '[': 'ج', ']': 'د',
        'a': 'ش', 's': 'س', 'd': 'ي', 'f': 'ب', 'g': 'ل', 'h': 'ا', 'j': 'ت', 'k': 'ن', 'l': 'م', ';': 'ك', '\'': 'ط',
        'z': 'ئ', 'x': 'ء', 'c': 'ؤ', 'v': 'ر', 'b': 'لا', 'n': 'ى', 'm': 'ة', ',': 'و', '.': 'ز', '/': 'ظ',
        '`': 'ذ', 'H': 'أ', 'Y': 'إ', 'T': 'لإ', 'G': 'لأ', 'B': 'لآ'
    };

    document.getElementById('serviceType').addEventListener('input', function(e) {
        let val = this.value;
        if(!val) return;
        let lastChar = val.slice(-1);
        if (/[a-z0-9`\[\];',\.\/]/.test(lastChar.toLowerCase()) && arabicMapping[lastChar.toLowerCase()]) {
            e.preventDefault();
            let mapped = arabicMapping[lastChar.toLowerCase()];
            this.value = val.slice(0, -1) + mapped;
        }
    });

    // --- Firebase configuration & init ---
    const firebaseConfig = {
        apiKey: "AIzaSyD718Ip6IZqKS02feem3p9V9u99_eTCST4",
        authDomain: "inwi-money-29903.firebaseapp.com",
        projectId: "inwi-money-29903",
        storageBucket: "inwi-money-29903.firebasestorage.app",
        messagingSenderId: "602309651736",
        appId: "1:602309651736:web:0c60aa1daab3ca5828026d",
        measurementId: "G-YPHDCXPPK3"
    };

    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const recordsCol = db.collection('invoiceRecords');
    const servicesDoc = db.collection('meta').doc('savedServices');


    // --- 2. منطق التطبيق (معدل للمزامنة مع Firestore) ---

    // ابدأ بعرض من localStorage كنسخة فورية
    let records = JSON.parse(localStorage.getItem('invoiceRecords')) || [];
    let savedServices = JSON.parse(localStorage.getItem('savedServices')) || [];
    let currentFilter = 'all';

    const elements = {
        service: document.getElementById('serviceType'),
        amount: document.getElementById('amount'),
        check: document.getElementById('initialCheck'),
        date: document.getElementById('currentDate'),
        list: document.getElementById('recordsList'),
        datalist: document.getElementById('servicesList'),
        
        // بطاقات الفلترة
        valAll: document.getElementById('val-all'),
        countAll: document.getElementById('count-all'),

        valPending: document.getElementById('val-pending'),
        countPending: document.getElementById('count-pending'),
        
        valReady: document.getElementById('val-ready'),
        countReady: document.getElementById('count-ready'),
        
        valPaid: document.getElementById('val-paid'),
        countPaid: document.getElementById('count-paid'),
    };

    elements.date.valueAsDate = new Date();

    renderServicesList();
    renderRecords();

    // عند اختيار اسم مسجل من الـ datalist انتقل تلقائياً إلى خانة المبلغ
    elements.service.addEventListener('input', function () {
        if (savedServices.includes(this.value)) {
            elements.amount.focus();
        }
    });

    document.getElementById('addBtn').addEventListener('click', addRecord);
    elements.date.addEventListener('change', renderRecords);

    // --- المزامنة من Firestore (real-time) ---
    recordsCol.onSnapshot(snapshot => {
        records = snapshot.docs.map(d => {
            const data = d.data() || {};
            // إذا لم يكن هناك time، استخرجه من الحقل id (إن وُجد)
            if (!data.time && data.id) {
                try {
                    data.time = new Date(data.id).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    data.time = '';
                }
            }
            return { ...data, docId: d.id };
        });
         localStorage.setItem('invoiceRecords', JSON.stringify(records));
         renderRecords();
     }, err => {
         console.warn('Firestore records onSnapshot error:', err);
     });

    servicesDoc.onSnapshot(doc => {
        if (doc.exists) {
            savedServices = doc.data().list || [];
        } else {
            savedServices = [];
        }
        savedServices.sort();
        localStorage.setItem('savedServices', JSON.stringify(savedServices));
        renderServicesList();
    }, err => {
        console.warn('Firestore services onSnapshot error:', err);
    });

    // utils
    function findRecordById(id) {
        return records.find(r => r.id === id);
    }
    function findDocIdById(id) {
        const r = findRecordById(id);
        return r ? r.docId : null;
    }

    // تغيير الفلتر
    window.setFilter = function(filterType) {
        currentFilter = filterType;
        
        // تحديث التصميم
        document.querySelectorAll('.filter-card').forEach(card => card.classList.remove('active'));
        document.getElementById(`filter-${filterType}`).classList.add('active');

        renderRecords();
    }

    function addRecord() {
        const service = elements.service.value.trim();
        const amount = parseFloat(elements.amount.value);
        const isChecked = elements.check.checked;
        const date = elements.date.value;

        if (!service || isNaN(amount) || !date) {
            alert('المرجو ملء المعلومات');
            return;
        }

        const newRecord = {
            id: Date.now(),
            service: service,
            amount: amount,
            isChecked: isChecked,
            isPaid: false,
            date: date
            // احفظ وقت التسجيل بصيغة ساعة:دقيقة
            , time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
         };

        // أضف في Firestore — onSnapshot سيحدّث الواجهة تلقائياً
        recordsCol.add(newRecord).then(() => {
            // تحديث قائمة الخدمات المخزنة في المستند
            if (!savedServices.includes(service)) {
                savedServices.push(service);
                savedServices.sort();
                servicesDoc.set({ list: savedServices })
                    .catch(e => console.warn('Failed to update services doc:', e));
            }
            // تنظيف الحقول فوراً
            elements.service.value = '';
            elements.amount.value = '';
            elements.check.checked = false;

            // توجيه الفلتر أو إعادة العرض سيتم عبر onSnapshot؛ لكن نحدّث الفلتر محلياً
            if (currentFilter !== 'all') {
                if (isChecked) setFilter('ready');
                else setFilter('pending');
            } else {
                // عرض فوري من localStorage أو موجود حالياً
                renderRecords();
            }
        }).catch(err => {
            console.error('Failed to add record to Firestore:', err);
            alert('خطأ في مزامنة السجل مع السحابة. حاول لاحقاً.');
        });
    }

    function toggleCheck(id) {
        const record = findRecordById(id);
        if (record && !record.isPaid) {
            const docId = findDocIdById(id);
            if (!docId) return;
            recordsCol.doc(docId).update({ isChecked: !record.isChecked })
                .catch(e => console.warn('toggleCheck update failed:', e));
        }
    }

    function markAsPaid(id) {
        const record = findRecordById(id);
        if (record) {
            if (!record.isChecked) {
                alert('لا يمكن الاستخلاص إلا بعد وضع علامة شيك');
                return;
            }
            const docId = findDocIdById(id);
            if (!docId) return;
            recordsCol.doc(docId).update({ isPaid: true })
                .catch(e => console.warn('markAsPaid failed:', e));
        }
    }

    function deleteRecord(id) {
        if (confirm('هل أنت متأكد من الحذف؟')) {
            const docId = findDocIdById(id);
            if (!docId) return;
            recordsCol.doc(docId).delete()
                .catch(e => console.warn('deleteRecord failed:', e));
        }
    }

    function renderServicesList() {
        elements.datalist.innerHTML = '';
        savedServices.forEach(s => {
            const option = document.createElement('option');
            option.value = s;
            elements.datalist.appendChild(option);
        });
    }

    function renderRecords() {
        elements.list.innerHTML = '';
        const selectedDate = elements.date.value;
        
        // 1. تحديد مجموعات البيانات للحساب
        
        // بيانات اليوم فقط (للأزرق والأحمر)
        const todayRecords = records.filter(r => r.date === selectedDate);
        
        // جميع البيانات (للبرتقالي والأخضر)
        const allRecords = records;

        // 2. الحسابات
        
        // الأزرق: مجموع اليوم (كل الحالات المسجلة في هذا اليوم)
        const sumAllToday = todayRecords.reduce((sum, r) => sum + r.amount, 0);
        
        // الأحمر: مستخلص اليوم (فقط المدفوع في هذا التاريخ)
        // ملاحظة: نفترض ان الدفع تم في نفس تاريخ السجل، أو ان المستخدم يرى سجلات مدفوعة بتاريخ اليوم
        const paidToday = todayRecords.filter(r => r.isPaid);
        const sumPaidToday = paidToday.reduce((sum, r) => sum + r.amount, 0);

        // البرتقالي: للمراجعة (الكل - تراكمي) - غير مدفوع وبدون شيك
        const pendingGlobal = allRecords.filter(r => !r.isPaid && !r.isChecked);
        const sumPendingGlobal = pendingGlobal.reduce((sum, r) => sum + r.amount, 0);

        // الأخضر: جاهز (الكل - تراكمي) - غير مدفوع وعليه شيك
        const readyGlobal = allRecords.filter(r => !r.isPaid && r.isChecked);
        const sumReadyGlobal = readyGlobal.reduce((sum, r) => sum + r.amount, 0);


        // 3. تحديث واجهة الكروت
        
        // الأزرق (اليوم)
        elements.valAll.textContent = sumAllToday.toFixed(2);
        elements.countAll.textContent = todayRecords.length + ' عملية';
        
        // البرتقالي (الكل)
        elements.valPending.textContent = sumPendingGlobal.toFixed(2);
        elements.countPending.textContent = pendingGlobal.length + ' فاتورة';

        // الأخضر (الكل)
        elements.valReady.textContent = sumReadyGlobal.toFixed(2);
        elements.countReady.textContent = readyGlobal.length + ' شيك';

        // الأحمر (اليوم)
        elements.valPaid.textContent = sumPaidToday.toFixed(2);
        elements.countPaid.textContent = paidToday.length + ' عملية';


        // 4. تحديد القائمة المعروضة في الأسفل
        let listToRender = [];
        
        if (currentFilter === 'all') {
            listToRender = todayRecords; // عرض سجلات اليوم
        } else if (currentFilter === 'paid') {
            listToRender = paidToday; // عرض مدفوعات اليوم
        } else if (currentFilter === 'pending') {
            listToRender = pendingGlobal; // عرض المعلق من كل الأيام
        } else if (currentFilter === 'ready') {
            listToRender = readyGlobal; // عرض الجاهز من كل الأيام
        }

        // الترتيب: من الأحدث إلى الأقدم في الصفحة الرئيسية (all)
        if (currentFilter === 'all') {
            listToRender.sort((a, b) => b.id - a.id); // newest first
        }

        // 5. رسم العناصر
        elements.list.innerHTML = '';
        listToRender.forEach(r => {
            const div = document.createElement('div');
            
            let statusClass = 'status-pending';
            let statusText = 'مراجعة';
            let actionsHtml = '';
            
            // إضافة التاريخ للعرض إذا كنا في قائمة تراكمية (برتقالي/أخضر)
            let dateBadge = '';
            if (currentFilter === 'pending' || currentFilter === 'ready') {
                dateBadge = `<span class="date-tag">${r.date}</span>`;
            }

            // وسم الوقت دائماً إن وجد
            const timeBadge = r.time ? `<span class="time-tag">${r.time}</span>` : '';

            if (r.isPaid) {
                statusClass = 'status-paid';
                statusText = 'مستخلص';
                actionsHtml = `<button class="action-btn delete-btn" onclick="deleteRecord(${r.id})">حذف</button>`;
            } else {
                if (r.isChecked) {
                    statusClass = 'status-checked';
                    statusText = 'جاهز';
                }

                const payDisabledAttr = r.isChecked ? '' : 'disabled';
                
                actionsHtml = `
                    <button class="action-btn check-btn ${r.isChecked ? 'is-checked' : ''}" 
                            onclick="toggleCheck(${r.id})">
                        ${r.isChecked ? '✓' : '-'}
                    </button>
                    
                    <button class="action-btn pay-btn" 
                            onclick="markAsPaid(${r.id})" 
                            ${payDisabledAttr}>
                        استخلاص
                    </button>
                    
                    <button class="action-btn delete-btn" onclick="deleteRecord(${r.id})">x</button>
                `;
            }

            div.className = `record-item ${statusClass}`;
            
            div.innerHTML = `
                <div class="record-info">
                    <strong>${r.service}</strong>
                    <span>${dateBadge}${statusText} ${timeBadge}</span>
                </div>
                <div class="record-amount">${r.amount.toFixed(2)}</div>
                <div class="actions">
                    ${actionsHtml}
                </div>
            `;
            elements.list.appendChild(div);
        });

        if (listToRender.length === 0) {
            elements.list.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">لا توجد بيانات</div>';
        }
    }
</script>

</body>
</html>